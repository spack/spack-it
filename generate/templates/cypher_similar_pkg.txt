MATCH (p:Package)
WHERE p.name <> "{{ pkg_name }}"
  AND NOT toLower(p.name) CONTAINS toLower("{{ pkg_name }}")
  AND "{{ build_sys }}" IN p.build_systems
OPTIONAL MATCH (p)-[:DEPENDS_ON]->(d:Package)
OPTIONAL MATCH (p)-[:HAS_VARIANT]->(v:Variant)
WITH p,
     size(apoc.coll.intersection({{ dependencies }}, collect(d.name))) AS dep_score,
     size(apoc.coll.intersection({{ variants }}, collect(v.name))) AS var_score
WITH p, dep_score, var_score,
     (0.6 * dep_score + 0.4 * var_score) AS total_score
ORDER BY total_score DESC
LIMIT {{ num_similar_refs }}
RETURN p.name AS match_name, p.recipe AS recipe, total_score